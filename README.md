# ULP 3: C Program for Packet Forwarding

In this task, you will implement your previously designed SA/RT model as a program that runs on the Nucleo Board together with the Baseboard.

Achieving this intermediate goal is a prerequisite for successful project implementation. Upon successful testing of this task, all Nucleo Boards can interact with the Baseboard (see Appendix B): A packet should be forwarded from one board to the next in a timely manner. To ensure all functions are tested, the self-test program should be successful.

#### Hardware of the Baseboard to be Used

The Baseboard (see Appendix B) contains 8x WS2812 RGB LEDs connected in a chain and inputs and outputs that can be used for neighbor synchronization.

##### WS2812

The LEDs can be controlled by Timer 2 Channel 3 via DMA.

If the Baseboard (see Appendix B) is operated without an external 5V power supply, the WS2812 LEDs can be powered via the Nucleo Board. For this, a jumper cable from the 5V pin of the mounted Nucleo Board (next to the Arduino 5V socket) is connected to the E5V of the Baseboard.

##### Inputs

The inputs marked with LS can be queried via an external interrupt. If you configure a pulldown, you can manually generate the signal from the neighbor by briefly connecting a jumper cable from the power supply to the LS input.

Inputs provided on the 20 cm x 20 cm adapter board for the handover pulse to the neighbors:

| Position | Signal-Name   | Pin | Morpho Connector | Baseboard Connector |
|----------|---------------|-----|------------------|----------------------|
| North    | from_N_LS1    | PC10| CN7.1            | LS1                  |
| East     | from_O_LS2    | PC11| CN7.2            | LS2                  |
| South    | from_S_LS3    | PC12| CN7.3            | LS3                  |
| West     | from_W_LS4    | PD2 | CN7.4            | LS4                  |

##### Outputs

All outputs marked with SV are on timer outputs and could serve as PWM outputs, e.g., to control model-building servos or additional WS2812 LED chains.

Outputs provided on the 20 cm x 20 cm adapter board for the handover pulse to the neighbors:

| Position | Signal-Name   | Pin | Morpho Connector | Baseboard Connector |
|----------|---------------|-----|------------------|----------------------|
| North    | to_N_SV8       | PB0 | CN7.34            | SV8                  |
| East     | to_O_SV3       | PA7 | CN10.15           | SV3                  |
| South    | to_S_SV4       | PA6 | CN10.13           | SV4                  |
| West     | to_W_SV5       | PB9 | CN10.5             | SV5                  |

#### I/O Processes

Fill the processes prepared in the last task with code to address the peripherals:

- The processes that represent receiving, sending, generating, and delivering a packet can be represented by animations/blinking sequences of the WS2812.
- Implement the control flow for receiving a packet from the neighbor via one of the LS pins in the corresponding callback handler and in the automaton.
- The process that signals the packet handover to the following neighbor sets an SV pin active for, e.g., 1 ms.
- Implement the process that updates the representation of the storage. Note that you also need to set the input/output LEDs, as only all 8 LEDs can be written at once.

#### Test Program and Tests

Download the test program from [here](https://github.com/Daenariz/es_ulp3/blob/master/ULP3_MMCP_v6_Tester.py) and put it into operation with your MMCP-Id and the serial port.

With the program, you can create various sending/receiving scenarios. The IDs of your neighbors before and after should be configurable in your software. For the test with the test program, configure your solution so that your neighbor before and after has the MMCP-ID+1.

Test the following sequences with the test buttons:

- **Regular create and pass on**: A packet is generated by ApNr. 42 with the MMCP-ID "0" (no button press required) and then sent to the valid neighbor with ApNr. 44 (with button press).
- **Regular await and deliver**: A packet is received by ApNr. 42 with the MMCP-ID of the neighbor (with button press) and then delivered with ApNr. 44 and MMCP-ID "0" (without button press).
- **Test storage integrity**: Various storage and retrieval operations, as well as creating seven different packets, to obtain the error message "Storage full."
- **Package already exists**: A packet is generated by ApNr. 42 with the MMCP-ID "0" (no button press required) and then generated again with ApNr. 42 with the MMCP-ID "0".
- **Package not available**: A packet that is not in storage should be sent by ApNr. 44.
- **Unknown partner-id**: 2 tests with ApNr. 42 and ApNr. 44 each with an invalid neighbor ID.
- **Forwarding Test** of ApNr. 43, which performs a forwarding from one neighbor to the next without storing the packet in between.
